# مراقب البطارية (Battery Monitor)

## وصف البرنامج

هذا البرنامج هو مراقب بطارية متقدم لأجهزة اللابتوب على نظام Linux Mint (أو أي توزيعة Linux تدعم sysfs). يقوم البرنامج بمراقبة حالة البطارية بشكل مستمر وإرسال إشعارات سطح المكتب عند مستويات شحن محددة لمساعدة المستخدم على الحفاظ على صحة البطارية.

### الهدف من البرنامج
- **تجنب الشحن الزائد**: ينبه المستخدم عندما يصل الشحن إلى مستويات عالية أثناء التوصيل بالشاحن.
- **تجنب التفريغ الكامل**: ينبه عند انخفاض الشحن إلى مستويات منخفضة أثناء عدم التوصيل.
- **إشعارات دائمة**: بعض الإشعارات (مثل البطارية المنخفضة أو الشحن الكامل) تبقى حتى يغلقها المستخدم يدوياً.
- **سجل الأحداث**: يسجل جميع الأحداث في ملف للمراجعة لاحقاً.

## الميزات الرئيسية

- **مراقبة متعددة البطاريات**: يدعم أجهزة تحتوي على أكثر من بطارية واحدة.
- **إشعارات مخصصة**: أيقونات وأهمية مختلفة حسب نوع الإشعار (منخفض، عالي، اقتراب الامتلاء، مكتمل).
- **سجل ذكي**: تدوير تلقائي لملف السجل عند تجاوزه حجم 1 ميجابايت.
- **واجهة سطر أوامر (CLI)**: خيارات متعددة لتخصيص السلوك.
- **إشعارات دائمة**: دعم لإشعارات تبقى حتى يغلقها المستخدم (عند دعم مدير الإشعارات مثل dunst).
- **فاصل زمني ديناميكي**: يقلل من الفحوصات عندما تكون البطارية في حالة مستقرة.
- **معالجة أخطاء قوية**: يتعامل مع الأخطاء دون إيقاف البرنامج.

## المتطلبات

- **نظام التشغيل**: Linux (مثل Linux Mint) مع دعم sysfs (/sys/class/power_supply).
- **Python**: الإصدار 3.6 أو أحدث.
- **مكتبات Python**: مدمجة (لا حاجة لتثبيت إضافي).
- **notify-send**: لإرسال الإشعارات (مثبت افتراضياً في معظم التوزيعات).
- **مدير إشعارات**: مثل dunst أو GNOME Shell للإشعارات الدائمة.

## التثبيت

1. **تحميل البرنامج**:
   - انسخ ملف `battery_monitoring.py` إلى مجلد مناسب، مثل `~/scripts/` أو `/home/abdelilah/Desktop/battery_notify/`.

2. **جعل الملف قابل للتنفيذ**:
   ```bash
   chmod +x /path/to/battery_monitoring.py
   ```

3. **تثبيت notify-send (إن لم يكن مثبتاً)**:
   ```bash
   sudo apt install libnotify-bin
   ```

4. **تثبيت dunst لإشعارات دائمة (اختياري)**:
   ```bash
   sudo apt install dunst
   ```
   ثم قم بتكوينه في `~/.config/dunst/dunstrc` لجعل الإشعارات ذات urgency=critical تبقى دائماً:
   ```
   [urgency_critical]
   timeout = 0
   ```

## التشغيل

### تشغيل يدوي
```bash
python3 /path/to/battery_monitoring.py
```

### تشغيل كخدمة systemd (موصى به للتشغيل التلقائي)
1. انسخ ملف `battery-monitor.service` إلى `~/.config/systemd/user/`:
   ```bash
   mkdir -p ~/.config/systemd/user
   cp battery-monitor.service ~/.config/systemd/user/
   ```

2. عدّل المسار في `battery-monitor.service` ليطابق موقع السكربت:
   ```
   ExecStart=/usr/bin/python3 /path/to/battery_monitoring.py
   ```

3. أعد تحميل systemd وفعّل الخدمة:
   ```bash
   systemctl --user daemon-reload
   systemctl --user enable --now battery-monitor.service
   ```

4. للتحقق من الحالة:
   ```bash
   systemctl --user status battery-monitor.service
   journalctl --user -u battery-monitor.service
   ```

## خيارات سطر الأوامر

| الخيار | الوصف | مثال |
|--------|--------|-------|
| `--interval`, `-i` | فترة التحقق بالثواني (افتراضي: 60) | `-i 30` |
| `--timeout`, `-t` | مهلة الإشعار بالميلي ثانية (افتراضي: 8000) | `-t 10000` |
| `--no-log-file` | عدم كتابة ملف السجل | `--no-log-file` |
| `--print-log` | طباعة السجل إلى stdout أثناء التشغيل | `--print-log` |
| `--show-log` | طباعة سجل الأحداث ثم الخروج | `--show-log` |
| `--tail` | عدد الأسطر الأخيرة عند --show-log (افتراضي: 100) | `--tail 50` |
| `--log-path`, `-l` | مسار ملف السجل (افتراضي: ~/battery_monitor.log) | `-l /var/log/battery.log` |
| `--no-notify` | عدم إرسال إشعارات (للاختبار) | `--no-notify` |

## أمثلة الاستخدام

- **تشغيل مع فحص كل 30 ثانية وإشعارات سريعة**:
  ```bash
  python3 battery_monitoring.py -i 30 -t 5000
  ```

- **عرض آخر 50 سطر من السجل**:
  ```bash
  python3 battery_monitoring.py --show-log --tail 50
  ```

- **تشغيل للاختبار بدون إشعارات**:
  ```bash
  python3 battery_monitoring.py --no-notify --print-log
  ```

- **سجل في مكان مخصص**:
  ```bash
  python3 battery_monitoring.py -l /home/user/my_battery.log
  ```

## الإشعارات والعتبات

| نوع الإشعار | العتبة | الشرط | المهلة | الأهمية |
|-------------|--------|--------|--------|---------|
| البطارية منخفضة | ≤ 20% | غير موصول | دائم (0) | critical |
| تجنب الشحن الزائد | ≥ 85% | موصول | 10 ثانية | normal |
| اقتراب الامتلاء | ≥ 95% | موصول | 12 ثانية | normal |
| الشحن مكتمل | ≥ 100% | موصول | دائم (0) | critical |

## ملاحظات إضافية

- **الأمان**: البرنامج يقرأ فقط من sysfs ولا يعدل أي شيء في النظام.
- **الأداء**: يستهلك موارد قليلة جدًا (CPU وذاكرة).
- **الأخطاء**: إذا فشل قراءة البطارية، يسجل الخطأ ويستمر.
- **التخصيص**: يمكن تعديل العتبات في الكود مباشرة إذا لزم الأمر.
- **الدعم**: يعمل على أي توزيعة Linux تدعم sysfs، لكن تم اختباره على Linux Mint.
- **الترخيص**: حر (open source)، يمكن تعديله وتوزيعه بحرية.

## استكشاف الأخطاء

- **لا تظهر إشعارات**: تأكد من تثبيت notify-send وتشغيل البرنامج في جلسة رسومية.
- **إشعارات لا تبقى دائماً**: استخدم dunst كمدير إشعارات وكوّنه كما هو موضح أعلاه.
- **أخطاء صلاحيات السجل**: استخدم مساراً في مجلد المستخدم أو أنشئ الملف مسبقاً مع صلاحيات مناسبة.
- **البرنامج لا يبدأ**: تحقق من مسار Python وأن الملف قابل للتنفيذ.

إذا واجهت مشكلة، تحقق من السجل أو شغّل مع `--print-log` للتشخيص.